'use client';
import { updateAppConfigAction } from "@/actions/app-config-action";
import { ToggleSection } from "@/components/primitives/toggle-section/toggle-section";
import { Group, Paper, Stack, Text, TextInput } from "@mantine/core";
import { notifications } from "@mantine/notifications";
import { useState } from "react";
import classes from "./admin-setting-overview-page-content-container.module.scss";
import UploadImageSection from "@/components/primitives/upload-image-section/upload-image-section";
import { IAppConfigResponse } from "@/interfaces/app-config-interface";
import { useDebouncedCallback } from "use-debounce";

interface AdminSettingOverviewPageContentContainerProps {
  appConfig: IAppConfigResponse | undefined;
}

export default function AdminSettingOverviewPageContentContainer({ appConfig }: AdminSettingOverviewPageContentContainerProps) {
  const [isMaintenanceMode, setIsMaintenanceMode] = useState(appConfig?.maintenanceMode);
  const [faviconUrl, setFaviconUrl] = useState(appConfig?.faviconUrl);
  const [logoUrl, setLogoUrl] = useState(appConfig?.logoUrl);
  const [isUpdatingLogoUrl, setIsUpdatingLogoUrl] = useState(false);
  const [isUpdatingFaviconUrl, setIsUpdatingFaviconUrl] = useState(false);
  const [phoneContact, setPhoneContact] = useState(appConfig?.phoneContact ?? '');

  const handleSelectFaviconUrl = async (imageUrl: string) => {
    setIsUpdatingFaviconUrl(true);
    try {
      await updateAppConfigAction({ faviconUrl: imageUrl });
      setFaviconUrl(imageUrl);
    } catch (error) {
      notifications.show({
        title: 'Failed to set image',
        message: error instanceof Error ? error.message : '',
        color: 'red',
      });
    } finally {
      setIsUpdatingFaviconUrl(false);
    }
  };

  const handleRemoveFaviconUrl = async () => {
    setIsUpdatingFaviconUrl(true);
    // Optimistic update UI
    setFaviconUrl('');
    // Update database
    await updateAppConfigAction({ faviconUrl: '' });
    setIsUpdatingFaviconUrl(false);
  };

  const handleSelectLogoUrl = async (imageUrl: string) => {
    setIsUpdatingLogoUrl(true);
    try {
      await updateAppConfigAction({ logoUrl: imageUrl });
      setLogoUrl(imageUrl);
    } catch (error) {
      notifications.show({
        title: 'Failed to set image',
        message: error instanceof Error ? error.message : '',
        color: 'red',
      });
    } finally {
      setIsUpdatingLogoUrl(false);
    }
  };

  const handleRemoveLogoUrl = async () => {
    setIsUpdatingLogoUrl(true);
    // Optimistic update UI
    setLogoUrl('');
    // Update database
    await updateAppConfigAction({ logoUrl: '' });
    setIsUpdatingLogoUrl(false);
  };

  const handleToggleMaintenanceMode = async (checked: boolean) => {
    const result = await updateAppConfigAction({ maintenanceMode: checked });

    if (result.success) {
      setIsMaintenanceMode(checked);
      notifications.show({
        title: 'Success',
        message: `Maintenance mode ${checked ? 'enabled' : 'disabled'}`,
        color: 'green',
      });
    } else {
      notifications.show({
        title: 'Error',
        message: result.error || 'Failed to update maintenance mode',
        color: 'red',
      });
    }
  };

  const handleUpdatePhoneContact = useDebouncedCallback(async (newPhoneContact: string) => {
    await updateAppConfigAction({ phoneContact: newPhoneContact });
    notifications.show({
      message: 'Saved successfully',
      color: 'green',
      position: 'top-right',
      autoClose: 900,
    });
  }, 1500);

  return (
    <div className={classes.overviewPageRoot}>
      <Stack gap="md">
        <Paper radius={'md'} shadow="xs" classNames={{ root: classes.paperBlock }}>
          <Stack p={'sm'}>
            <Text size="lg" fw={600}>Favicon</Text>
            <Group align="center">
              <UploadImageSection size="lg" isLoading={isUpdatingFaviconUrl} imageUrl={faviconUrl ?? undefined}
                onImageSelect={handleSelectFaviconUrl} onRemoveFile={handleRemoveFaviconUrl}
              />
              <Stack gap={2}>
                <Text size="lg">{faviconUrl ? 'Edit' : 'Upload'}</Text>
                <Text size="sm" c="dimmed">png, jpg; jpeg; Size ≤ 2M</Text>
              </Stack>
            </Group>
          </Stack>
        </Paper>
        <Paper radius={'md'} shadow="xs" classNames={{ root: classes.paperBlock }}>
          <Stack p={'sm'}>
            <Text size="lg" fw={600}>Logo website</Text>
            <Group align="center">
              <UploadImageSection size="lg" isLoading={isUpdatingLogoUrl} imageUrl={logoUrl ?? undefined}
                onImageSelect={handleSelectLogoUrl} onRemoveFile={handleRemoveLogoUrl}
              />
              <Stack gap={2}>
                <Text size="lg">{logoUrl ? 'Edit' : 'Upload'}</Text>
                <Text size="sm" c="dimmed">png, jpg; jpeg; Size ≤ 2M</Text>
              </Stack>
            </Group>
          </Stack>
        </Paper>
        <Paper radius={'md'} classNames={{ root: classes.paperBlock }}>
          <Stack p={'sm'} gap={'xs'}>
            <Text size="lg" fw={600}>Hotline</Text>
            <Stack gap={2}>
              <Text size="lg">Whatsapp</Text>
              <TextInput
                size="md"
                maxLength={15}
                type="number"
                value={phoneContact}
                placeholder="Enter your phone number"
                onChange={(e) => {
                  setPhoneContact(e.target.value);
                  handleUpdatePhoneContact(e.target.value);
                }}
              />
            </Stack>
          </Stack>
        </Paper>
        <Paper radius={'md'} classNames={{ root: classes.paperBlock }}>
          <ToggleSection
            checked={isMaintenanceMode ?? false}
            onToggle={handleToggleMaintenanceMode}
            text="Maintenance Mode"
            checkedSubText="Website is currently in maintenance mode"
            uncheckedSubText="Website is currently active"
          />
        </Paper>
      </Stack>
    </div>
  );
}
